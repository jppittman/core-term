name: Automatic Revert on Failed Postsubmit

on:
  workflow_run:
    workflows: ["Postsubmit Flake Detection"]
    branches: ["main", "master"]
    types: [completed]

jobs:
  revert:
    name: Revert failed commit
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get the failing commit
        id: commit
        run: |
          # Get the commit that triggered the workflow_run
          COMMIT_SHA=${{ github.event.workflow_run.head_commit.id }}
          COMMIT_MSG=$(git log -1 --format=%B $COMMIT_SHA)
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Revert the commit
        run: |
          # Revert the failing commit
          git revert --no-edit ${{ steps.commit.outputs.sha }}

      - name: Push revert to main
        run: |
          git push origin HEAD:refs/heads/${{ github.event.workflow_run.head_branch }}

      - name: Create revert notification issue
        uses: actions/github-script@v7
        with:
          script: |
            const failingCommit = '${{ steps.commit.outputs.sha }}';
            const failingCommitMsg = '${{ steps.commit.outputs.message }}';
            const workflowRunUrl = '${{ github.event.workflow_run.html_url }}';

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Automatic revert: Failed flake detection for ${failingCommit.substring(0, 7)}`,
              body: `## Automatic Revert Triggered\n\nThe following commit was automatically reverted due to failed flake detection tests:\n\n**Commit:** \`${failingCommit}\`\n\n**Original message:**\n\`\`\`\n${failingCommitMsg}\n\`\`\`\n\n**Failed workflow:** [View details](${workflowRunUrl})\n\nThis typically indicates a flaky test that intermittently fails. Please investigate and fix the underlying issue.`,
              labels: ['flake-detected', 'automatic-revert']
            });
